{% extends 'base.html' %}

{% block title %}Заказ{% endblock %}

{% block content %}
<h1>Заказ</h1>
<script>
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    })
</script>
<div class="dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
       data-bs-toggle="dropdown" aria-expanded="false">
        Навигация по контрагенту
    </a>
    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
        <li>
            <a href="{% url 'contractor_detail' object.contract.contractor.id %}"
               class="dropdown-item">Контрагент</a>
        </li>

        <li>
            <a href="{% url 'contractor_contracts_list' object.contract.contractor.id %}"
               class="dropdown-item">Договоры</a>
        </li>

        <li>
            <a href="{% url 'contractor_orders_list' object.contract.contractor.id %}"
               class="dropdown-item">Заказы</a>
        </li>
    </ul>
</div>
{% load static %}
<div class="mb-1 col-12">
    <div class="card">
        <ul class="list-group list-group-horizontal">
            <li class="list-group-item">
                <a href="{% url 'order_edit' object.id %}" class="btn btn-primary">
                    Редактирование
                </a>
            </li>

            <li class="list-group-item">
                {% if object.to_delete %}
                <form method="post" action="{% url 'order_to_delete' object.id %}">
                    {% csrf_token %}
                    <input type="submit" name="unmark-to-delete" value="Снять пометку на удаление"
                           class="btn btn-outline-danger">
                </form>
                {% else %}
                <form method="post" action="{% url 'order_to_delete' object.id %}">
                    {% csrf_token %}
                    <input type="submit" name="mark-to-delete" value="Пометить на удаление"
                           class="btn btn-outline-danger">
                </form>
                {% endif %}
            </li>
        </ul>

        <div class="card-body d-flex justify-content-between">
            <h5 class="card-title">Заказ №{{ object.number }}</h5>
            {% if object.to_delete %}
            <p class="text-danger fw-bold">Помечен на удаление</p>
            {% endif %}
        </div>

        <ul class="list-group list-group-flush">
            <li class="list-group-item">
                Договор:
                <a class="text-reset" href="{% url 'contract_detail' object.contract.id %}">
                    {{ object.contract }}
                </a>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <div>
                    Контрагент:
                    <a class="text-reset" href="{% url 'contractor_detail' object.contract.contractor.id %}">
                        {{ object.contract.contractor.title }}
                    </a>
                </div>

                <div>
                    Организация:
                    <a class="text-reset" href="{% url 'organization_detail' object.contract.organization.id %}">
                        {{ object.contract.organization.title }}
                    </a>
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <div>
                    Условия поставки: {{ object.delivery_conditions }}
                </div>

                <div>
                    Время поставки, дней: {{ object.delivery_time }}
                </div>

                <div>
                    Место поставки: {{ object.delivery_address }}
                </div>
            </li>
            <li class="list-group-item d-flex justify-content-between">
                <div>
                    Условия оплаты:
                    <a tabindex="0" class="text-reset payment-condition-popover"
                       role="button" data-bs-toggle="popover" title="{{ object.payment_conditions.title }}"
                       data-bs-content="{{ object.payment_conditions.description }}">
                        {{ object.payment_conditions }}
                    </a>

                    <script>
                    var popover = new bootstrap.Popover(document.querySelector('.payment-condition-popover'), {
                      trigger: 'focus'
                    })


                    </script>
                </div>

                <div>
                    Валюта:
                    <a tabindex="0" class="text-reset currency-popover"
                       role="button" data-bs-toggle="popover" title="{{ object.contract.currency.title }}"
                       data-bs-content="{{ object.contract.currency.nominal }} {{ object.contract.currency.char_code }} = {{ object.contract.currency.cost }} RUB">
                        {{ object.contract.currency }}
                    </a>

                    <script>
                    var popover = new bootstrap.Popover(document.querySelector('.currency-popover'), {
                      trigger: 'focus'
                    })
                    </script>
                </div>

                <div>
                    Дата создания: {{ object.created }}
                </div>
            </li>
            <li class="list-group-item">Ответственный: {{ object.responsible }}</li>
        </ul>

        <ul class="list-group list-group-horizontal">
            {% ifequal "Россия" object.contract.contractor.country %}
            <li class="list-group-item">
                {% if object.contract.contractor.russian_requisites %}
                <a href="{% url 'download_invoice' object.id %}" class="btn btn-success d-block">Скачать счет</a>
                {% else %}
                <a tabindex="0" class="btn btn-danger invoice-popover"
                   role="button" data-bs-toggle="popover" title="Отказ"
                   data-bs-content="Чтобы сформировать инвойс, необходимо заполнить реквизиты в карточке контрагента">
                    Скачать счет
                </a>
                <script>
                    var popover = new bootstrap.Popover(document.querySelector('.invoice-popover'), {
                      trigger: 'focus'
                    })
                </script>
                {% endif %}
            </li>
            <li class="list-group-item">
                {% if object.contract.contractor.russian_requisites %}
                <a href="{% url 'download_upd' object.id %}" download class="btn btn-success col-offset-2">
                    Скачать УПД
                </a>
                {% else %}
                <a tabindex="0" class="btn btn-danger upd-popover"
                   role="button" data-bs-toggle="popover" title="Отказ"
                   data-bs-content="Чтобы сформировать УПД, необходимо заполнить реквизиты в карточке контрагента">
                    Скачать УПД
                </a>
                <script>
                    var popover = new bootstrap.Popover(document.querySelector('.upd-popover'), {
                      trigger: 'focus'
                    })
                </script>
                {% endif %}
            </li>
            {% endifequal %}
            {% ifnotequal "Россия" object.contract.contractor.country %}
            <li class="list-group-item">
                <a href="{% url 'download_invoice' object.id %}" class="btn btn-success d-block">Скачать счет</a>
            </li>
            <li class="list-group-item">
                <a href="{% url 'download_specification' object.id %}" download
                   class="btn btn-success col-offset-2">Скачать спецификацию</a>
            </li>

            <li class="list-group-item">
                <a href="{% url 'download_goods_acceptance' object.id %}" class="btn btn-success d-block">
                    Скачать акт приемки товаров
                </a>
            </li>
            {% endifnotequal %}
        </ul>
    </div>
</div>

<h2>Выпускаемая продукция</h2>
<table class="table">
    <thead>
    <tr>
        <th scope="col">Продукция</th>
        <th scope="col">Склад</th>
        <th scope="col">Количество</th>
        <th scope="col">Стандартная цена</th>
        <th scope="col">Итоговая цена</th>
        <th scope="col">Расчетная сумма</th>
        <th scope="col">Итоговая сумма</th>
        <th scope="col">Редактировать</th>
        <th scope="col">Удалить</th>
    </tr>
    </thead>
    <tbody>
    {% for document in object.bookings.all %}
    <tr>
        <td>
            <a href="{% url 'product_detail' document.product.id %}" class="text-reset">{{ document.product }}</a>
        </td>
        <td>{{ document.store }}</td>
        <td>{{ document.quantity }}</td>
        <td>{{ document.product.cost }}</td>
        <td>{{ document.total_price }}</td>
        <td>{{ document.counted_sum }}</td>
        <td>{{ document.total_sum }}</td>
        <td>
            <a href="{% url 'order_booking_edit' document.id %}">
                <img src="{% static 'app_documents/images/edit.png' %}" alt="edit icon">
            </a>
        </td>
        <td>
            <a href="{% url 'order_booking_delete' document.id %}">
                <img src="{% static 'app_documents/images/delete.png' %}" alt="delete icon">
            </a>
        </td>
    </tr>
    {% endfor %}
    </tbody>
    <tfoot>
        <tr>
            <td>Итого:</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>{{ object.counted_sum }}</td>
            <td>{{ object.total_sum }}</td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>Итого в {{ object.contract.currency.char_code }}:</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>{{ currency_counted_sum }}</td>
            <td>{{ currency_total_sum }}</td>
            <td></td>
            <td></td>
        </tr>
    </tfoot>
</table>

{% endblock %}